sequenceDiagram
    participant Client as Machine Client
    participant OAuth as Backend (routers/oauth.py)
    participant TokenSvc as TokenService (token_service.py)
    participant DB as PostgreSQL

    Note over Client,DB: CLIENT CREDENTIALS FLOW<br/>(machine-to-machine, no user context)

    Client->>OAuth: POST /oauth/token<br/>Content-Type: x-www-form-urlencoded<br/>body: grant_type=client_credentials<br/>&client_id={id}<br/>&client_secret={secret}<br/>&scope={requested_scopes}

    alt Missing client_id or client_secret
        OAuth-->>Client: 400 {error: "invalid_request",<br/>error_description: "client_credentials requires<br/>client_id and client_secret"}
    end

    OAuth->>TokenSvc: authenticate_client(db, client_id, client_secret)
    TokenSvc->>DB: SELECT FROM oauth_apps<br/>WHERE client_id = {id}
    alt App not found
        TokenSvc-->>OAuth: None
        OAuth-->>Client: 401 {error: "invalid_client",<br/>error_description: "Invalid client credentials"}
    end
    TokenSvc->>TokenSvc: bcrypt.checkpw(secret, app.client_secret_hash)
    alt Secret mismatch
        TokenSvc-->>OAuth: None
        OAuth-->>Client: 401 {error: "invalid_client",<br/>error_description: "Invalid client credentials"}
    end
    TokenSvc-->>OAuth: Authenticated OAuthApp

    OAuth->>TokenSvc: issue_token(db, app, scopes)
    TokenSvc->>TokenSvc: Filter requested scopes<br/>against app.scopes
    TokenSvc->>TokenSvc: Sign RS256 JWT with RSA private key<br/>{iss: issuer_url,<br/>sub: client_id (NOT user),<br/>aud: client_id,<br/>exp: now + 3600,<br/>iat: now,<br/>jti: uuid,<br/>scope: "granted scopes",<br/>client_id: client_id}<br/>NOTE: NO user_id claim
    TokenSvc->>TokenSvc: Compute SHA256(jwt) for storage
    TokenSvc->>DB: INSERT INTO access_tokens<br/>(token_hash, scopes, client_id,<br/>user_id=NULL, expires_at)

    OAuth-->>Client: 200 {<br/>access_token: "rs256_jwt",<br/>token_type: "Bearer",<br/>expires_in: 3600,<br/>scope: "granted scopes"<br/>}<br/>NOTE: No id_token (no user)

    Note over Client,DB: Using the token

    Client->>OAuth: GET /oauth/userinfo<br/>Authorization: Bearer {access_token}
    OAuth->>TokenSvc: introspect_token(db, token)
    TokenSvc->>DB: Lookup by SHA256(token)
    OAuth->>OAuth: Token valid but user_id is NULL
    OAuth-->>Client: 401 {error: "invalid_token",<br/>error_description: "Token has no user context"}

    Note over Client: client_credentials tokens<br/>CANNOT access /oauth/userinfo<br/>(no user context attached)

    Note over Client,DB: Token introspection

    Client->>OAuth: POST /oauth/token/introspect<br/>body: token={access_token}<br/>&client_id={id}&client_secret={secret}
    OAuth->>TokenSvc: introspect_token(db, token)
    TokenSvc->>DB: Lookup by SHA256(token)
    alt Token valid
        OAuth-->>Client: 200 {active: true,<br/>scope, client_id, user_id: null,<br/>token_type: "Bearer", exp, iat, jti, iss}
    else Token invalid/expired/revoked
        OAuth-->>Client: 200 {active: false}
    end

    Note over Client,DB: Token revocation

    Client->>OAuth: POST /oauth/token/revoke<br/>body: token={access_token}<br/>&client_id={id}&client_secret={secret}
    OAuth->>TokenSvc: revoke_token(db, token)
    TokenSvc->>DB: UPDATE access_tokens SET revoked=true<br/>WHERE token_hash = SHA256(token)
    OAuth-->>Client: 200 {}
