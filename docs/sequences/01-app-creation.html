<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sequence: OAuth App Creation</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0a0a0a; color: #e5e5e5; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; }
    h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: #fff; }
    p.subtitle { font-size: 0.875rem; color: #888; margin-bottom: 2rem; }
    .diagram-container { width: 100%; max-width: 1200px; overflow-x: auto; background: #111; border: 1px solid #222; border-radius: 8px; padding: 2rem; }
    .mermaid { display: flex; justify-content: center; }
    .mermaid svg { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h1>OAuth App Creation Flow</h1>
  <p class="subtitle">CreateApp.tsx &rarr; routers/apps.py &rarr; app_service.py &rarr; PostgreSQL</p>
  <div class="diagram-container">
    <pre class="mermaid">
sequenceDiagram
    actor Dev as Developer
    participant FE as Frontend (CreateApp.tsx)
    participant API as Backend (routers/apps.py)
    participant SVC as AppService (app_service.py)
    participant HASH as Hashing (security/hashing.py)
    participant VAL as Scope Validator (scopes.py)
    participant DB as PostgreSQL (oauth_apps)

    Dev->>FE: Fill form: name, description,<br/>redirect_uris, scopes, icon, privacy_policy_url

    Note over FE: Client-side validation:<br/>name required, at least 1 redirect URI,<br/>icon max 2MB (png/jpg/gif/webp/svg)

    FE->>FE: Filter empty redirect URIs from list

    alt No redirect URIs after filtering
        FE-->>Dev: Toast error: "At least one redirect URI is required"
    end

    FE->>API: POST /api/apps/<br/>body: {name, description, scopes[],<br/>redirect_uris[], privacy_policy_url}

    API->>SVC: create_app(db, name, description,<br/>scopes, redirect_uris, ...)

    SVC->>VAL: _validate_scopes(scopes)
    VAL->>VAL: Compare against VALID_SCOPE_NAMES:<br/>{openid, profile, email, cohort,<br/>activity, socials, wallet, offline_access}

    alt Invalid scopes detected
        VAL-->>API: HTTPException(400)<br/>"Invalid scopes: x, y"
        API-->>FE: 400 {detail: "Invalid scopes: x, y"}
        FE-->>Dev: Toast error with detail message
    end

    SVC->>HASH: generate_client_id()
    HASH-->>SVC: 32-char hex string<br/>(secrets.token_hex(16))

    SVC->>HASH: generate_client_secret()
    HASH-->>SVC: ~64-char base64url string<br/>(secrets.token_urlsafe(48))

    SVC->>HASH: hash_client_secret(plaintext_secret)
    HASH-->>SVC: bcrypt hash string

    SVC->>DB: INSERT INTO oauth_apps<br/>(id=uuid4, name, client_id,<br/>client_secret_hash, scopes[],<br/>redirect_uris[], icon_url,<br/>privacy_policy_url,<br/>created_at=now, updated_at=now)
    DB-->>SVC: Row committed + refreshed

    SVC-->>API: Tuple(OAuthApp, plaintext_secret)

    API-->>FE: 201 Created<br/>{id, name, client_id, client_secret,<br/>scopes, redirect_uris, icon_url,<br/>privacy_policy_url, created_at, updated_at}

    Note over FE: client_secret is returned<br/>ONCE â€” stored as bcrypt hash<br/>in DB, never retrievable again

    opt Icon file was selected by user
        FE->>API: POST /api/apps/{id}/icon<br/>Content-Type: multipart/form-data<br/>(FormData with "file" field)
        alt Upload succeeds
            API-->>FE: 200 Updated app with icon_url
        else Upload fails
            API-->>FE: Error response
            FE-->>Dev: Toast warning:<br/>"App created but icon upload failed"
        end
    end

    FE-->>Dev: Success screen:<br/>- Warning: secret shown only once<br/>- client_id + client_secret display<br/>- "Copy both credentials" button<br/>- Scopes + redirect URIs summary<br/>- Link to app detail page
    </pre>
  </div>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      sequence: {
        actorMargin: 40,
        noteMargin: 10,
        messageMargin: 30,
        mirrorActors: false,
        wrap: true,
        width: 200,
      },
      themeVariables: {
        primaryColor: '#1a1a2e',
        primaryBorderColor: '#4a4a6a',
        primaryTextColor: '#e5e5e5',
        lineColor: '#6366f1',
        secondaryColor: '#16213e',
        tertiaryColor: '#0f3460',
        noteBkgColor: '#1e1e3f',
        noteTextColor: '#e5e5e5',
        noteBorderColor: '#4a4a6a',
        actorBkg: '#1a1a2e',
        actorBorder: '#6366f1',
        actorTextColor: '#e5e5e5',
        signalColor: '#e5e5e5',
      },
    });
  </script>
</body>
</html>
