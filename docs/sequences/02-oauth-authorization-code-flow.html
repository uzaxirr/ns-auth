<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sequence: OAuth Authorization Code Flow (Login)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0a0a0a; color: #e5e5e5; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; }
    h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: #fff; }
    p.subtitle { font-size: 0.875rem; color: #888; margin-bottom: 2rem; }
    .diagram-container { width: 100%; max-width: 1400px; overflow-x: auto; background: #111; border: 1px solid #222; border-radius: 8px; padding: 2rem; }
    .mermaid { display: flex; justify-content: center; }
    .mermaid svg { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h1>OAuth Authorization Code Flow — Authorization &amp; Login</h1>
  <p class="subtitle">Home.tsx &rarr; /oauth/authorize &rarr; LoginPage.tsx &rarr; Privy &rarr; /auth/login/privy &rarr; session cookie</p>
  <div class="diagram-container">
    <pre class="mermaid">
sequenceDiagram
    actor User as End User
    participant Client as Demo App (Home.tsx)
    participant OAuth as Backend (routers/oauth.py)
    participant SessionSvc as SessionService
    participant Login as Frontend (LoginPage.tsx)
    participant AuthR as Backend (routers/auth.py)
    participant PrivySvc as PrivyService
    participant Privy as Privy (auth.privy.io)
    participant DB as PostgreSQL

    Note over User,DB: PHASE 1 — Client initiates authorization request

    User->>Client: Click "Sign in with Network School"
    Client->>Client: generatePKCE() in pkce.ts:<br/>code_verifier = 32 random bytes<br/>code_challenge = base64url(SHA256(verifier))<br/>state = crypto.randomUUID()
    Client->>Client: sessionStorage.setItem<br/>("pkce_code_verifier", verifier)<br/>("oauth_state", state)

    Client->>OAuth: GET /oauth/authorize<br/>?response_type=code<br/>&client_id={VITE_CLIENT_ID}<br/>&redirect_uri={VITE_REDIRECT_URI}<br/>&scope={VITE_SCOPES}<br/>&state={state}<br/>&code_challenge={challenge}<br/>&code_challenge_method=S256

    Note over OAuth: Validate request parameters

    OAuth->>DB: get_app_by_client_id(client_id)

    alt response_type != "code"
        OAuth-->>Client: 400 {error: "unsupported_response_type",<br/>error_description: "Only 'code' is supported"}
    end
    alt client_id not found in DB
        OAuth-->>Client: 400 {error: "invalid_client",<br/>error_description: "Unknown client_id"}
    end
    alt redirect_uri not in app.redirect_uris
        OAuth-->>Client: 400 {error: "invalid_request",<br/>error_description: "redirect_uri not registered"}
    end

    Note over OAuth: Check user session

    OAuth->>SessionSvc: get_session_user_id(request)
    SessionSvc->>SessionSvc: Read "ns_session" cookie<br/>Verify HS256 JWT with session_secret

    alt Session cookie valid — user authenticated
        OAuth-->>User: 302 Redirect to<br/>{FRONTEND_URL}/consent?{all_params}
    else No session or invalid cookie
        OAuth-->>User: 302 Redirect to<br/>{FRONTEND_URL}/login?{all_params}
    end

    Note over User,DB: PHASE 2 — Login (only if unauthenticated)

    User->>Login: Browser navigates to /login?{params}
    Login->>Login: useEffect: auto-trigger Privy modal<br/>(useRef guard prevents StrictMode double-fire)
    Login->>Privy: Privy SDK login()<br/>(email OTP / Google / Apple)
    User->>Privy: Complete authentication
    Privy-->>Login: authenticated = true
    Login->>Privy: getAccessToken()
    Privy-->>Login: ES256 JWT (privy_token)

    Login->>AuthR: POST /auth/login/privy<br/>body: {privy_token: jwt}<br/>credentials: "include"

    AuthR->>PrivySvc: verify_privy_token(jwt)
    PrivySvc->>Privy: Fetch JWKS from auth.privy.io<br/>Verify ES256 signature
    alt Invalid Privy JWT
        PrivySvc-->>AuthR: Verification failed
        AuthR-->>Login: 401 {error: "invalid_token",<br/>error_description: "Privy token verification failed"}
    end
    PrivySvc-->>AuthR: Decoded payload {sub: privy_did}

    AuthR->>PrivySvc: get_privy_user(privy_did)
    PrivySvc->>Privy: GET /api/v1/users/{did}<br/>(Basic auth: app_id:app_secret)
    Privy-->>PrivySvc: {linked_accounts: [{type:"email", address:"user@x.com"}]}

    AuthR->>DB: get_or_create_user_from_privy(privy_did, email)<br/>If new user: INSERT with empty profile fields<br/>If existing: return user record

    AuthR->>SessionSvc: create_session_token(user.id)<br/>HS256 JWT {sub:user_id, iat, exp, type:"session"}
    AuthR->>SessionSvc: set_session_cookie(response, token)<br/>Cookie: ns_session, httponly=true, path=/<br/>Production: secure=true, samesite=none<br/>Local: secure=false, samesite=lax

    AuthR-->>Login: 200 {user: {id, email, display_name, ...}}<br/>+ Set-Cookie: ns_session=...

    Login-->>User: window.location.href =<br/>/consent?{original_params}
    </pre>
  </div>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      sequence: {
        actorMargin: 40,
        noteMargin: 10,
        messageMargin: 30,
        mirrorActors: false,
        wrap: true,
        width: 200,
      },
      themeVariables: {
        primaryColor: '#1a1a2e',
        primaryBorderColor: '#4a4a6a',
        primaryTextColor: '#e5e5e5',
        lineColor: '#6366f1',
        secondaryColor: '#16213e',
        tertiaryColor: '#0f3460',
        noteBkgColor: '#1e1e3f',
        noteTextColor: '#e5e5e5',
        noteBorderColor: '#4a4a6a',
        actorBkg: '#1a1a2e',
        actorBorder: '#6366f1',
        actorTextColor: '#e5e5e5',
        signalColor: '#e5e5e5',
      },
    });
  </script>
</body>
</html>
